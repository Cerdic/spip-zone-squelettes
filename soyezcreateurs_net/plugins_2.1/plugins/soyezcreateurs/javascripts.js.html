#CACHE{30*24*3600,cache-client}
#HTTP_HEADER{Content-Type: text/javascript; charset=iso-8859-1}
// Menu accessible dynamique et CSS alternatives, V 2.0 (avec jquery)
//
// Copyright (c) 2004 Jacques PYRAT
// http://www.pyrat.net/
//
// Licensed under the LGPL license
// http://www.gnu.org/copyleft/lesser.html
//
// **********************************************************************
// This program is distributed in the hope that it will be useful, but
// WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. 
// **********************************************************************
//
// Presets
var jp_blankpic='#CHEMIN{images/1.gif}';
var jp_onclass='menu_plus';
var jp_offclass='menu_minus';
var jp_picalt='<:soyezcreateurs:menu_picalt:>';
var jp_strDeplier='<:soyezcreateurs:menu_deplier:>';
var jp_strReplier='<:soyezcreateurs:menu_replier:>';
var jp_parentID='menu';
// Déclaration de variables
var altAttr='';
var titleAttr='';
// Checking for DOM compatibility	
if (document.getElementById && document.createTextNode && document.createElement){jp_canDOM=true}

function jp_expinit2() {
	// Parcour des sous menus pour leurs appliquer à chacuns la bonne apparence
	$('#'+jp_parentID+' li.smenu').each(function() {
		// cibles
		var imgInsert_target = $(this).find('a:first'); 
		var ul_target = $(this).find('ul:first'); 
		var a_target = $(this).find('a:first'); 
		
		//Création de l'image
		$('<img/>', {
			src: jp_blankpic,
			alt: jp_picalt,
			className: 'node'
		}).insertBefore(imgInsert_target);
			
		// Application des attributs en fonction de la présence ou non du strong
		if($(this).find("strong").size() > 0) {	
			var pic_alt = jp_picalt+jp_strReplier+$(a_target).attr('text');
			$('img.node', this).attr({
				'className':jp_offclass,
				'title':pic_alt,
				'alt':pic_alt
			});
			$(ul_target).css('display', 'block');
		} else {
			var pic_alt = jp_picalt+jp_strDeplier+$(a_target).attr('text');
			$('img.node', this).attr({
				'className':jp_onclass,
				'title':pic_alt,
				'alt':pic_alt
			});
			$(ul_target).css('display', 'none');
		}
	});
}

function jp_ex2(event) {
	//Définition des cibles
	var img_target = $(event.target).parents("li:first").find("img:first");
	var ul_target = $(event.target).parents("li:first").find("ul:first");
	var a_target = $(event.target).parents("li:first").find("a:first");
	
	// Fermeture/ouverture
	if( ( (event.type=='click' || event.type=='focusin') && $(ul_target).css('display')=='none') || (event.type=='keypress' && event.which==43) ) {
		$(img_target).addClass(jp_offclass).removeClass(jp_onclass);
		$(ul_target).css('display', 'block');
		var jp_strAltNew = jp_picalt+jp_strReplier+$(a_target).attr('text');
	} else {
		if(event.type=='click' || (event.type=='keypress' && event.which==45)) {
			$(img_target).addClass(jp_onclass).removeClass(jp_offclass);
			$(ul_target).css('display', 'none');
			var jp_strAltNew = jp_picalt+jp_strDeplier+$(a_target).attr('text');
		}
	}
	
	// On change les info bulle
	$(img_target).attr({'alt':jp_strAltNew,'title':jp_strAltNew});
	// On ajuste le Layout
	adjustLayout();
	// On rafraichie les info bulle si elle sont afficher avec tooltips
	rafraichirTooltip(img_target);	
}

function rafraichirTooltip(target) {
	[(#CONFIG{soyezcreateurs/native_tooltips}|=={on}|non)
	$(target).each(function() {
		var this_alt = $(this).attr('alt');
		var this_title = $(this).attr('title');
		$(this).tooltip({ 
			track: false, 
			delay: 0, 
			showURL: false, 
			showBody: " - ", 
			fade: 250 
		});
		$(this).attr({alt:this_alt,title:this_title});
	});
	]
}

function hoverAttr(event) {
	if(event.type=='mouseenter') {
		altAttr=$(event.target).attr('alt');
		titleAttr=$(event.target).attr('title');
		$(event.target).attr({alt:'',title:''});
	} else 
		if(event.type=='mouseleave') $(event.target).attr({alt:altAttr,title:titleAttr});
}

function adjustLayout() {
	/* Remettre la taille à auto pour trouver l'eventuelle nouvelle hauteur !*/
	$("div.equilibre").css({'height': 'auto'});
	/*******************************************CAS N°1********************************************************************/
	/*Nav, Contenu et Extra alignes top (Layout 1 a 22)*/
	var tnotstackable =0;
	tnotstackable = parseInt($("div.notstackable")[0].offsetTop);
	tlaststackable = parseInt($("div.laststackable")[0].offsetTop);
	if (tnotstackable==tlaststackable) {
			var h=0;
			$("div.equilibre").each(function(){ h=Math.max(h,this.offsetHeight); }).css({'height': h+'px'});
			$("div.equilibre").css({'height': parseInt($("div.equilibre")[0].offsetHeight)});
			/*alert("Cas 1");*/
	}
	else {
/*********************************************CAS 2*********************************************************************/
	/* Navigation et Extra sont empiles (Layout 23 a 26 et 33 et 34)*/
		leftlaststackable = parseInt($("div.laststackable")[0].offsetLeft);
		leftnavigation = parseInt($("div#navigation")[0].offsetLeft);
		largeurnavigation = parseInt($("div#navigation")[0].offsetWidth);
		largeurextra = parseInt($("div.laststackable")[0].offsetWidth);
		if ((leftlaststackable == leftnavigation) && (largeurextra == largeurnavigation)) {
			var hstacked = 0;
			$("div.stackable").each(function(){ hstacked+=parseInt(this.offsetHeight); });
			var hnotstackable = 0;
			hnotstackable = parseInt($("div.notstackable")[0].offsetHeight);
			if (hnotstackable>hstacked) {
				$("div.laststackable").css({'height': hnotstackable + parseInt($("div.laststackable")[0].offsetHeight) - hstacked+'px'});
				$("div.notstackable").css({'height': hnotstackable+'px'});
				/*alert("Cas 2");*/
			}
			else {
				$("div.notstackable").css({'height': hstacked+'px'});
			};
		}
		else {
/**********************************************CAS 3*******************************************************************/
	/* Navigation et Extra meme Top et differents de Contenu (Layout 27-28-39-40)*/
			tlaststackable = parseInt($("div.laststackable")[0].offsetTop);
			tstackable = parseInt($("div.stackable")[0].offsetTop);
			if (tstackable==tlaststackable){
				$("div.stackable").css({'height': parseInt($("div.stackable")[0].offsetHeight)});
				var h=0;
				$("div.stackable").each(function(){ h=Math.max(h,this.offsetHeight); }).css({'height': h+'px'});
				/*alert("Cas 3");*/
			}
			else {
/**********************************************CAS 4*******************************************************************/
	/* Navigation et Contenu meme alignement Top (Layout 35 et 36)*/
				largeurcontenu = parseInt($("div.notstackable")[0].offsetWidth);
				if (largeurcontenu==largeurextra) {
					hstackable = (hauteurcontenu = parseInt($("div.notstackable")[0].offsetHeight)) + (hauteurext = parseInt($("div.laststackable")[0].offsetHeight));
					hnavigation = parseInt($("div#navigation")[0].offsetHeight);
					if(hstackable < hnavigation) {
						$("div.notstackable").css({'height': (hnavigation - hauteurext)+'px'});
					}
					else {
						$("div#navigation").css({'height': hstackable+'px'});
					}
					/*alert("Cas 4");*/
				}
				else	{
/**********************************************CAS 5*******************************************************************/
	/* Navigation et Contenu meme alignement Top (Layout 29 a 32 et 37 et 38)*/
					hstackable = (hauteurcontenu = parseInt($("div.notstackable")[0].offsetHeight));
					hnavigation = parseInt($("div#navigation")[0].offsetHeight);
					if(hstackable > hnavigation) {
						$("div#navigation").css({'height': hstackable+'px'});
					}
					else {
					$("div.notstackable").css({'height': hnavigation+'px'});
					}
					/*alert("Cas 5");*/
				}
			}
		}
	}
}
;
/* FUNCTIONS ON ALL PAGES */
function myInitPages() {
    jQuery('body').addClass('hasJS');
	[(#CONFIG{soyezcreateurs_layout/menuderoulant,replie}|=={replie}|oui)jp_expinit2();]
	// Surligner l'evenement en cours
	var id_anchor  = location.hash.substr(1); //Get the word after the hash from the url
	if (id_anchor) $('#'+id_anchor).parent().addClass('highlight_anchor'); // ajoute la classe highlight_anchor à l'element autour de l'ancre
	if (CanceladjustLayout != true) {
		adjustLayout();
		$("body").resize(
			function () {
			adjustLayout();
			}
		);
		if (CancelMonitorTextSize != true) {
			$.em.element = $('<div />').css({ left:     '-100em',
										position: 'absolute',
										width:    '100em' })
								 .prependTo('div.texte')[0];
			$('div.texte').bind('emchange', function(e, cur, prev) { adjustLayout(); });
		}
		onAjaxLoad(adjustLayout); // Merci Marcimat sur IRC !
	}
;
	rafraichirTooltip('a, input, select, img, button, h2, h3, dd, acronym, abbr, area');
	$(".escapelinks a").focus( function() { $(".escapelinks").removeClass("escapelinks"); } );

}
;
/* BLACK TRANSPARENT BACKGROUNDS */
function mySpecialBackgrounds(elt,correcAmount,correcAmount2) {
	jQuery(elt).each(function() {
		var targetHeight = jQuery(this).parent().height();
		var targetWidth = jQuery(this).parent().width();
		jQuery(this).css({'height':targetHeight+correcAmount,'width':targetWidth+correcAmount2,'opacity':.5});
	});
}
;
/* HOME SPECIAL FEATURE */
function myHomeSpecialFeature(container,item,decoImg,decoSpan) {
	jQuery('#'+item+'1').addClass('active'+item);
	mySpecialBackgrounds('.'+item+' .'+decoSpan,14,10);
	jQuery('#'+item+'1 .'+decoSpan).css("opacity", 1);
	jQuery('.'+item+' .'+decoImg).hide();
	jQuery('#'+item+'1 .'+decoImg).show();

	var x = 1;
	var maxX = jQuery('.'+item).size();
	function myAnimate(x,maxX) {
		if (x > maxX) { x = 1; }
		jQuery('.'+item).removeClass('active'+item);
		jQuery('#'+item+x).addClass('active'+item);
		jQuery('.'+item+' .'+decoSpan).animate({"opacity": .5}, { queue:false, duration:800 });
		jQuery('#'+item+x+' .'+decoSpan).animate({"opacity": 1},800);
		jQuery('.'+item+' .'+decoImg).fadeOut(800);
		jQuery('#'+item+x+' .'+decoImg).fadeIn(800);
		timer = setTimeout(function() {
			if (x < maxX) { x = x+1; myAnimate(x,maxX); }
			else if (x = maxX) { x = 1; myAnimate(x,maxX); }
		} , 5000 );
	}
	myAnimate(x,maxX);

	jQuery('.'+item).each(function() {
		jQuery(this).hover(
			function() {
				clearTimeout(timer);
				currentItem = jQuery('.'+item).index(this)+1;
				jQuery('.'+item).removeClass('active'+item);
				jQuery(this).addClass('active'+item);
				jQuery('.'+item+' .'+decoSpan+':not("#'+item+currentItem+' .'+decoSpan+'")').css("opacity", .5);
				jQuery(this).children().children('.'+decoSpan).animate({"opacity": 1},400);
				jQuery('.'+item+' .'+decoImg+':not("#'+item+currentItem+' .'+decoImg+'")').fadeOut(400);
				jQuery(this).children('.'+decoImg).fadeIn(400);
			},
			function() {
				clearTimeout(timer);
				currentItem = jQuery('.'+item).index(this)+2;
				jQuery(this).removeClass('active'+item);
				jQuery(this).children().children('.'+decoSpan).animate({"opacity": .5},400);
				timer = setTimeout(function() { myAnimate(currentItem,maxX); } , 1000 );
			}
		);
	});
}
;

/* HOME CYCLE */
function homeCarousel(elt) {
	/* carousels internes */
	var elemNbr = jQuery(elt+' > li').size();
	var myCounter = 1;
	function onAfter(curr,next,opts) {
		if (opts.currSlide+1 == opts.slideCount) {
			if (myCounter < elemNbr) {
				myCounter = myCounter+1;
			} else if (myCounter == elemNbr) {
				myCounter = 1;
			}

			function reloadCarousels() {
				jQuery('.smallCarousel').stop(true,true).fadeOut(750);
				jQuery('#sc'+myCounter+'b').stop(true,true).fadeIn(750).children('ul').cycle({
				    //fx: 'scrollHorz', // pour transition latÃ©rale
				    fx: 'fade',
				    speed: 1500,
				    timeout: 4000,
					pause: true,
					startingSlide: 0,
					after: onAfter
				});
			jQuery('.mainCarousel').removeClass('active');
			if (myCounter == 1) {
				jQuery('.mainCarousel:first').addClass('active');
			} else {
					jQuery('.mainCarousel').eq(myCounter-1).addClass('active');
			}
		}
			jQuery('.smallCarousel').children('ul').cycle('stop');
			var t2=setTimeout(reloadCarousels,3000);
		} else {
			clearTimeout(t2);
		}
		//alert(myCounter);
	}
	function onAfter2(curr,next,opts) {
		//
	}
	jQuery('.smallCarousel ul').cycle({
	    //fx: 'scrollHorz', // pour transition latÃ©rale
	    fx: 'fade',
	    speed: 1500,
	    timeout: 4000,
		pause: true,
		startingSlide: 0,
		after: onAfter
	});
	jQuery('.smallCarousel').hide().children('ul').cycle('pause');
	jQuery('#sc1b').show().children('ul').cycle('resume');
	/* faux carousel principal */
	var whatToShow = '';
	jQuery('.mainCarousel:first').addClass('active');
	jQuery('.mainCarousel').live('mouseenter focus', function() {
		jQuery('.mainCarousel').removeClass('hover active');
		jQuery(this).addClass('hover active');
		whatToShow = jQuery(this).children('h2').children('a').attr('id');
		jQuery('.smallCarousel').stop(true,true).fadeOut().children('ul').cycle('stop');
		// jQuery(whatToShow).stop(true,true).fadeIn().children('ul').cycle({fx: 'scrollHorz',speed: 1500,timeout: 4000,pause: true,after: onAfter2}).cycle('resume'); // avec transition latÃ©rale
		jQuery('#'+whatToShow+'b').stop(true,true).fadeIn().children('ul').cycle({fx: 'fade',speed: 1500,timeout: 4000,pause: true,startingSlide: 0,after: onAfter2});
	}).live('mouseleave blur', function() {
		whatToShow = jQuery(this).children('h2').children('a').attr('id');
		jQuery(this).removeClass('hover');
		// jQuery('.smallCarousel').stop(true,true).fadeOut().children('ul').cycle({fx: 'scrollHorz',speed: 1500,timeout: 4000,pause: true,after: onAfter}).cycle('pause'); // avec transition latÃ©rale
		jQuery('.smallCarousel').stop(true,true).fadeOut().children('ul').cycle('stop');
		jQuery('#'+whatToShow+'b').stop(true,true).fadeIn().children('ul').cycle({fx: 'fade',speed: 1500,timeout: 4000,pause: true,startingSlide: 0,after: onAfter});
		myCounter = jQuery(this).index()+1;
	});
}

$(document).ready(function() {
	myInitPages();
	/* HOME SPECIAL FEATURE */
	if (jQuery('#homeSpecialFeature').size() > 0) { initMyHomeSpecialFeature = myHomeSpecialFeature("#homeSpecialFeature",'hSFItem','hSFDecoImg','hSFDecoSpan'); }
	if (jQuery('#arretSurImg .mainCarousels').size() > 0) { homeCarousel('.mainCarousels'); }
	
	$('#'+jp_parentID+' img.'+jp_offclass).live("click", function(event) jp_ex2(event));
	$('#'+jp_parentID+' img.'+jp_onclass).live("click", function(event) jp_ex2(event));
	$('#'+jp_parentID+' .smenu a').live("focusin", function(event) jp_ex2(event));
	$('#'+jp_parentID+' .smenu a').live("keypress", function(event) jp_ex2(event));
	$('a, input, select, img, button, h2, h3, dd, acronym, abbr, area').live("mouseenter", function(event) hoverAttr(event));
	$('a, input, select, img, button, h2, h3, dd, acronym, abbr, area').live("mouseleave", function(event) hoverAttr(event));
});

