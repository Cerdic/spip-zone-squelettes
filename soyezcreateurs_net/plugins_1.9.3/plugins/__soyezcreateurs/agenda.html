#CACHE{30*24*3600}
<?php
$months = array('', '<:date_mois_1:>', '<:date_mois_2:>', '<:date_mois_3:>', '<:date_mois_4:>', '<:date_mois_5:>', '<:date_mois_6:>', '<:date_mois_7:>', '<:date_mois_8:>', '<:date_mois_9:>', '<:date_mois_10:>', '<:date_mois_11:>', '<:date_mois_12:>');
$days = array('<:date_jour_1:>', '<:date_jour_2:>', '<:date_jour_3:>', '<:date_jour_4:>', '<:date_jour_5:>', '<:date_jour_6:>', '<:date_jour_7:>');
if (!isset($date_ev) || $date_ev == '') $date_ev = date('Y-m-d');

ereg("^([0-9]{4})-([0-9]{2})-([0-9]{2}).*$", $date_ev, $regs);
$cal_day = mktime(0, 0, 0, $regs[2], $regs[3], $regs[1]);

$D = date('d', $cal_day);
$M = date('m', $cal_day);
$Y = date('Y', $cal_day);

if (!isset($genre)) $genre = "<:pyrat:tout:>";

$titrePage = '<:pyrat:agenda|texte_script:> - '.$months[intval($M)].' '.$Y;

// Liste des rubriques de l agenda
$branche = array();
<BOUCLE_courante(RUBRIQUES){id_rubrique}>
	<BOUCLE_branche(RUBRIQUES){branche}>
		$branche[] = #ID_RUBRIQUE;
	</BOUCLE_branche>
</BOUCLE_courante>

// Construction liste des evenements (1 liste par jour => liste des jours)
$events = array();
<BOUCLE_evts_com(EVENEMENTS){statut=publie}{date_debut>(#ENV{date_ev,(#ENV{date})}|affdate{'Y-m-01'}|DateAdd{-6})}{date_debut<(#ENV{date_ev,(#ENV{date})}|affdate{'Y-m-01'}|DateAdd{35})}{par date_debut}><B_EvenementArticle>
	if ('#DATE_DEBUT' != '' && in_array(#ID_RUBRIQUE, $branche)) {
		$dateEvt = ereg_replace("^([0-9]{4})-([0-9]{2})-([0-9]{2}).*$", "\\1\\2\\3", '#DATE_DEBUT');
		if (!isset($events[$dateEvt])) { $events[$dateEvt] = array(); }
		$res="";
		ereg("($genre)", '<BOUCLE_genre(MOTS){id_evenement}>[(#TITRE|texte_script)]</BOUCLE_genre>', $res);
		if (($genre=='<:pyrat:tout:>') || ($genre==$res[1])) {
			<BOUCLE_EvenementArticle(ARTICLES){id_article}>$events[$dateEvt][] = array('rub' => #ID_RUBRIQUE, 'link' => '#URL_ARTICLE', 'title' => '[(#TITRE|texte_script)][&nbsp;: (#_evts_com:TITRE|=={#TITRE}|?{'',[(#_evts_com:TITRE|texte_script)]})]', 'logo' => '<BOUCLE_TitreRubrique(RUBRIQUES){id_rubrique}>[<img src="/(#LOGO_ARTICLE_RUBRIQUE||image_reduire{32,32}|extraire_attribut{src})" class="logo_agenda" alt="[(#TITRE|attribut_html|texte_script)]" title="[(#TITRE|attribut_html|texte_script)]" />]</BOUCLE_TitreRubrique>', 'genres' => '<B_Genres><em>(<BOUCLE_Genres(MOTS){id_evenement}{", "}><a href="#URL_MOT" rel="tag" title="<:pyrat:savoirpluscritere:>: [(#TITRE|attribut_html|texte_script)]">[(#TITRE|texte_script)]</a></BOUCLE_Genres>)</em></B_Genres>', 'titre_rub' => '<B_TitreRub><strong<BOUCLE_CouleurRub(MOTS){id_rubrique}{type=_CouleurRubrique}> style="background-color:#[(#TEXTE|couleur_eclaircir)];"</BOUCLE_CouleurRub>><BOUCLE_TitreRub(RUBRIQUES){id_rubrique}>[(#TITRE|attribut_html|texte_script)</strong>&nbsp;: ]</BOUCLE_TitreRub>');</BOUCLE_EvenementArticle>
		}
	}
</B_EvenementArticle></BOUCLE_evts_com>

?>
<BOUCLE_rubrique_principal(RUBRIQUES) {id_rubrique}>
<?php $jp_rubrique = [(#ID_RUBRIQUE|texte_script)]; ?>
<?php $titre = '[(#TITRE|attribut_html|texte_script)] - '.$months[intval($M)].' '.$Y; ?>
<?php $titretop = '[(#TITRE|attribut_html|nettoyer_marqueur|texte_script)]'; ?>
<INCLURE{fond=header}>
	<div id="miettesdepain">
	<ul>
	<li><a href="#URL_SITE_SPIP"><:pyrat:accueil:></a></li>
	<BOUCLE_plan(HIERARCHIE){id_rubrique}><li><a href="#URL_SITE_SPIP/spip.php?page=agenda&amp;id_rubrique=#_rubrique_principal:ID_RUBRIQUE"[ title="(#DESCRIPTIF|attribut_html)"]>[(#TITRE)]</a></li>
	</BOUCLE_plan>
	<li>[(#TITRE)]</li>
	</ul>
	</div>

<div class="texte">
<!-- Une : contenu de la rubrique -->
<div class="cartouche">
<h1>[(#SET{lelogo,[(#MODELE{rubrique_logo}{mode=normal}|image_reduire{64,64})]})][<img class="logo_rubrique" src="/(#GET{lelogo}|extraire_attribut{src})" width="[(#GET{lelogo}|extraire_attribut{width})]" height="[(#GET{lelogo}|extraire_attribut{height})]" alt="[(#TITRE|texte_script|supprimer_tags|entites_html) (logo)]" />]
[(#TITRE)]<?php echo ' - '.$months[intval($M)].' '.$Y; ?></h1>
</div>

<B_themes>
<div id="artrecents" class="flottant">
<h2><:pyrat:themes:></h2>
<BOUCLE_themes(RUBRIQUES){racine}{id_secteur}><B_sous_rubriques1>
<!-- Les themes avec recursivite -->
	<ul>
		<BOUCLE_sous_rubriques1(RUBRIQUES){id_parent}{par titre}>
			<li[ style="list-style-image: url(/(#MODELE{rubrique_logo}{mode=normal}|image_reduire{9,9}|extraire_attribut{src}));"]>
			<?php if ($jp_rubrique != [(#ID_RUBRIQUE|texte_script)]) { ?>
			<a href="#URL_RUBRIQUE?date_ev=[(#ENV{date_ev,[(#ENV{date})]}|annee)]-01-01[&amp;genre=(#ENV{genre,''}|urlencode)]" title="[(#DESCRIPTIF|attribut_html)] ([(#DATE|nom_jour)] [(#DATE|affdate)])"><?php } ?>[(#TITRE)]<?php if ($jp_rubrique != [(#ID_RUBRIQUE|texte_script)]) { ?></a><?php } ?>
			<BOUCLE_RecursionRubriques(BOUCLE_sous_rubriques1)></BOUCLE_RecursionRubriques>
			</li>
		</BOUCLE_sous_rubriques1>
	</ul>
</B_sous_rubriques1></BOUCLE_themes>
</div></B_themes>

	<div id="letexte">
[<div class="descriptif">(#DESCRIPTIF)</div>]
[(#TEXTE)]

<!-- Fabrication du tableau : l'en tete -->

		<form id="frmnavigation" method="get" action="#SELF"><fieldset><legend><:pyrat:precisezrecherche:></legend>
		<BOUCLE_PremiereAnnee(EVENEMENTS){statut=publie}{branche}{par date_debut}{0,1}>
		<?php if (!([(#DATE_DEBUT|annee)]==[(#ENV{date_ev,[(#ENV{date})]}|annee)] && [(#ENV{date_ev,[(#ENV{date})]}|mois)]==01)) { ?>
		<a href="#URL_SITE_SPIP/spip.php?page=agenda&amp;id_rubrique=#_rubrique_principal:ID_RUBRIQUE&amp;date_ev=<?php echo (($M - 1 > 0) ? $Y : ($Y - 1)); ?>-<?php printf('%02d', ($M - 1) > 0 ? ($M - 1) : 12); ?>-01[&amp;genre=(#ENV{genre,''}|urlencode)]"><img src="/#CHEMIN{images/prev.gif}" title="<:precedent:>" alt="<:precedent:>" /></a>
		<?php } ?>
		</BOUCLE_PremiereAnnee>
		<select id="var_nav_month">
		<?php
		for($i = 1; $i < 13; $i++) {
			echo '<option value="'.sprintf('%02d', $i).'"'.($i == $M ? ' selected="selected" ' : '').'>'.$months[$i].'</option>';
		}
		?>
		</select>
		<select id="var_nav_year">
		<BOUCLE_Annees(EVENEMENTS){statut=publie}{branche}{par date_debut}>[
		<option value="[(#DATE_DEBUT|annee)]"[(#ENV{date_ev,[(#ENV{date})]}|annee|=={[(#DATE_DEBUT|annee)]}|?{' selected="selected"',''})]>(#DATE_DEBUT|annee|unique)</option>
		]</BOUCLE_Annees>
		</select>

		<!-- Construction Menu selection -->
		<B_ListMotsClefs>[(#REM) Objectif : n'afficher que les mots clefs effectivement utilise' dans le secteur]
		<select id="var_nav_cle">
		<option value=""[(#ENV{genre,''}|=={''}|?{' selected="selected"',''})]><:pyrat:tout:></option>
		<BOUCLE_ListMotsClefs(EVENEMENTS){statut=publie}{id_secteur}{par titre}>
		<BOUCLE_MotClefAssocie(MOTS){id_evenement}{unique}>
		<option value="[(#TITRE|attribut_html)]"[(#ENV{genre}|=={[(#TITRE|attribut_html)]}|?{' selected="selected"',''})]>[(#TITRE)]</option>
		</BOUCLE_MotClefAssocie>
		</BOUCLE_ListMotsClefs>
		</select>
		</B_ListMotsClefs>

		<input type="button" value="<:pass_ok:>" class="form_submit" onclick="document.location.href='#URL_SITE_SPIP/spip.php?page=agenda&amp;id_rubrique=#_rubrique_principal:ID_RUBRIQUE&amp;date_ev=' + document.getElementById('var_nav_year').value + '-' + document.getElementById('var_nav_month').value + '-01&amp;genre=' + document.getElementById('var_nav_cle').value ; return false;" />
		<BOUCLE_DerniereAnnee(EVENEMENTS){statut=publie}{branche}{!par date_debut}{0,1}>
		<?php if (!([(#DATE_DEBUT|annee)]==[(#ENV{date_ev,[(#ENV{date})]}|annee)] && [(#ENV{date_ev,[(#ENV{date})]}|mois)]==12)) { ?>
		<a href="#URL_SITE_SPIP/spip.php?page=agenda&amp;id_rubrique=#_rubrique_principal:ID_RUBRIQUE&amp;date_ev=<?php echo (($M + 1 < 13) ? $Y : ($Y + 1)); ?>-<?php printf('%02d', ($M + 1) < 13 ? ($M + 1) : 1); ?>-01[&amp;genre=(#ENV{genre,''}|urlencode)]"><img src="/#CHEMIN{images/next.gif}" title="<:suivant:>" alt="<:suivant:>" /></a>
		<?php } ?>
		</BOUCLE_DerniereAnnee>
		<?php if ( ([(#ENV{date}|annee)] != [(#ENV{date_ev,[(#ENV{date})]}|annee)]) || ([(#ENV{date}|mois)] != [(#ENV{date_ev,[(#ENV{date})]}|mois)]) ) { ?>
		<input type="button" value="Aujourd'hui" onclick="document.location.href='#URL_SITE_SPIP/spip.php?page=agenda&amp;id_rubrique=#_rubrique_principal:ID_RUBRIQUE&amp;date_ev=<?php echo (date('Y-m-d')); ?>&amp;genre=<?php echo $genre ?>'; return false;" />
		<?php } ?>
		</fieldset>
		</form>

<h2>[(#TITRE)]</h2>
<table class="agenda" summary="<:pyrat:agendamoisde:> <?php echo $months[intval($M)].'&nbsp;'.$Y;?>">
<caption>
		<?php
				echo $months[intval($M)].'&nbsp;';
		?>
		<a href="#URL_RUBRIQUE?date_ev=[(#ENV{date}|annee)]-01-01&amp;genre=<?php echo urlencode((($genre=='<:pyrat:tout:>')?'':$genre)); ?>&amp;calendrier=1" title="<:pyrat:voirdetailannee:> [(#ENV{date}|annee)]">[(#ENV{date}|annee)]</a>
</caption>
<!-- Fabrication du tableau : les donnees -->
<tr>
	<?php
	for($i = 1; $i < 8; $i++) {
		echo '<th class="agendahead" scope="col">'.$days[$i%7].'</th>';
	}
	$TempD = 1;
	if(date('w', mktime(0, 0, 0, $M, 1, $Y)) != 1) {
		echo '</tr><tr>';
		$tmp = '';
		while(date('w', mktime(0, 0, 0, $M, $TempD, $Y)) != 1) {
			$TempD--;
			$case = '<td valign="top" class="agendanotthismonth">';
			$case .= date('j', mktime(0, 0, 0, $M, $TempD, $Y));
			$date_ev = date('Ymd', mktime(0, 0, 0, $M, $TempD, $Y));
			if (isset($events[$date_ev])) {
				$countev = $TempD;
				while (list(, $event) = each($events[$date_ev])) {
					$case .= ((($countev % 2)==0) ? '<div >' : '<div class="odd">').$event['logo'].(($event['logo'] == '') ? $event['titre_rub'] : '').'<a href="'.$event['link'].'">'.$event['title'].'</a> '.$event['genres'].'</div>';
					$countev++;
				}
			}
			$case .= '</td>';
			$tmp = $case.$tmp;
		}
		echo $tmp;
	}
	$TempD = 1;
	while((date('m', mktime(0, 0, 0, $M, $TempD, $Y)) == $M) || (date('w', mktime(0, 0, 0, $M, $TempD, $Y)) != 1)) {
		if(date('w', mktime(0, 0, 0, $M, $TempD, $Y)) == 1) {
			echo '</tr><tr>';
		}
		$date_ev = date('Ymd', mktime(0, 0, 0, $M, $TempD, $Y));
		echo '<td valign="top" class="agenda'.(date('m', mktime(0, 0, 0, $M, $TempD, $Y)) != $M ? 'not' : '').'this'.(date('Ymd', mktime(0, 0, 0, $M, $TempD, $Y)) == date('Ymd') ? 'day' : 'month').(isset($events[$date_ev]) ? ' event' : '').'">';
		echo date('j', mktime(0, 0, 0, $M, $TempD, $Y));
		if (isset($events[$date_ev])) {
			$countev = $TempD;
			while (list(, $event) = each($events[$date_ev])) {
				echo ((($countev % 2)==0) ? '<div >' : '<div class="odd">').$event['logo'].(($event['logo'] == '') ? $event['titre_rub'] : '').'<a href="'.$event['link'].'">'.$event['title'].'</a> '.$event['genres'].'</div>';
				$countev++;
			}
		}
		echo '</td>';
		$TempD++;
	}
	?>
</tr>
</table>
<p>&nbsp;</p>
[<div class="notes">(#NOTES)</div>]
	</div><!-- Fin de #LeTexte -->
</div><!-- Fin de .texte -->

</BOUCLE_rubrique_principal>
</B_rubrique_principal>
<?php $titre = '<:pyrat:erreur|texte_script:>'; ?>
<?php $titretop = '<:pyrat:erreur|nettoyer_marqueur|texte_script:>'; ?>
<INCLURE{fond=header}{connexion}>
<:pyrat:erreur_rubriqueexistepas:>
<//B_rubrique_principal>
[(#FORMULAIRE_ADMIN)]
<INCLURE{fond=footer}>


