#CACHE{24*3600}
<?php
$months = array('', '<:date_mois_1:>', '<:date_mois_2:>', '<:date_mois_3:>', '<:date_mois_4:>', '<:date_mois_5:>', '<:date_mois_6:>', '<:date_mois_7:>', '<:date_mois_8:>', '<:date_mois_9:>', '<:date_mois_10:>', '<:date_mois_11:>', '<:date_mois_12:>');
$days = array('<:pyrat:date_j_1:>', '<:pyrat:date_j_2:>', '<:pyrat:date_j_3:>', '<:pyrat:date_j_4:>', '<:pyrat:date_j_5:>', '<:pyrat:date_j_6:>', '<:pyrat:date_j_7:>');
$days_long = array('<:date_jour_1:>', '<:date_jour_2:>', '<:date_jour_3:>', '<:date_jour_4:>', '<:date_jour_5:>', '<:date_jour_6:>', '<:date_jour_7:>');

$M = intval(date('m', time()));
$Y = intval(date('Y', time()));
$events = array();
?>
<B_agenda>
<div class="miniagenda">
<BOUCLE_agenda(RUBRIQUES){titre_mot=Agenda}{id_parent=0}>
	[(#REM) Mémoriser les articles de la branche ]
	#SET{articlesbranche,#ARRAY}
	<BOUCLE_lesarticles(ARTICLES){id_secteur}>[(#SET{articlesbranche,
		[(#GET{articlesbranche}|push{#ID_ARTICLE})]})]</BOUCLE_lesarticles>
	<?php
	$events = array();
	$eventstitle = array();
	$eventscolor = array();
	<BOUCLE_evenements(EVENEMENTS){id_article IN #GET{articlesbranche}}{date_debut>(#ENV{date}|affdate{'Y-m-01'}|DateAdd{-6})}{date_debut<(#ENV{date}|affdate{'Y-m-01'}|DateAdd{35})}{par date_debut}>
	$date = ereg_replace("^([0-9]{4})-([0-9]{2})-([0-9]{2}).*$", "\\1\\2\\3", '#DATE_DEBUT');
	if ($date > date("Ymd", mktime(0, 0, 0, $M, -7, $Y)) && $date < date("Ymd", mktime(0, 0, 0, $M + 1, 7, $Y))) {
		<BOUCLE_EvenementArticle(ARTICLES){id_article}>
			if (!isset($events[$date])) { $events[$date] = array(); }
			$events[$date][] = '#URL_ARTICLE';
			if (!isset($eventstitle[$date])) { $eventstitle[$date] = array(); }
			$eventstitle[$date][] = '[(#TITRE|attribut_html|texte_script)][&nbsp;: (#_evenements:TITRE|=={#TITRE}|?{'',[(#_evenements:TITRE|attribut_html|texte_script)]})]';
			if (!isset($eventscolor[$date])) { $eventscolor[$date] = array(); }
			$eventscolor[$date][] = '<BOUCLE_CouleurRub(MOTS){id_rubrique}{type=_CouleurRubrique}> style="background-color:#[(#TEXTE)];"</BOUCLE_CouleurRub>';
		</BOUCLE_EvenementArticle>
	}
	</BOUCLE_evenements>
	?>
<h2[ title="(#DESCRIPTIF|attribut_html)"]>[(#TITRE)]</h2>
<div class="fond">
<table class="agenda" summary="[(#DESCRIPTIF|sinon{<:pyrat:agenda_summary:>}|attribut_html)]">
<caption>
	<a href="spip.php?page=agenda&amp;id_rubrique=#ID_RUBRIQUE" title="<:pyrat:voirdetailmois:> [(#ENV{date}|nom_mois)]">[(#ENV{date}|nom_mois)]</a> <img src="/#CHEMIN{images/1.gif}" alt="" width="1" height="1" />&nbsp;<a href="[(#URL_RUBRIQUE|parametre_url{calendrier,1})]" title="<:pyrat:voirdetailannee:> [(#ENV{date}|annee)]">[(#ENV{date}|annee)]</a>
</caption>
<tr>
	<?php
	for($i = 1; $i < 8; $i++) {
		echo '<th class="agendahead" scope="col"><abbr title="'.$days_long[$i%7].'">'.$days[$i%7].'</abbr></th>';
	}
	$TempD = 1;
	$Time = mktime(0, 0, 0, $M, 1, $Y);
	if(date('w', mktime(0, 0, 0, $M, 1, $Y)) != 1) {
		echo '</tr><tr>';
		$tmp = '';
		while(date('w', $Time) != 1) {
			$TempD--;
	        $Time =  mktime(0, 0, 0, $M, $TempD, $Y);
			if (isset($events[date('Ymd', $Time)])) {
				if (count($events[date('Ymd', $Time)]) == 1) {
				  $case = '<td class="agendanotthismonth event">';
				  $case .= '<a'.$eventscolor[date('Ymd', $Time)][0].' href="'.$events[date('Ymd', $Time)][0].'" title="'.$eventstitle[date('Ymd', $Time)][0].'">'.date('j', $Time).'</a>';
				} else {
				  $case = '<td class="agendanotthismonth events">';
				  $case .= '<a href="spip.php?page=agenda&amp;id_rubrique=#ID_RUBRIQUE" title="[(#TITRE|attribut_html)]">'.date('j', $Time).'</a>';
				}
			} else {
				$case = '<td class="agendanotthismonth">';
				$case .= date('j', $Time);
			}
			$tmp = $case.'</td>'.$tmp;
		}
		echo $tmp;
	}
	$TempD = 1;
	$Time = mktime(0, 0, 0, $M, 1, $Y);
	while((date('m', $Time) == $M) || (date('w', $Time) != 1)) {
		if(date('w', $Time) == 1) {
			echo '</tr><tr>';
		}
		if (isset($events[date('Ymd', $Time)])) {
				if (count($events[date('Ymd', $Time)]) == 1) {
				  echo '<td class="agenda'.(date('m', $Time) != $M ? 'not' : '').'this'.(date('Ymd', $Time) == date('Ymd') ? 'day' : 'month').' event">';
				  echo '<a'.$eventscolor[date('Ymd', $Time)][0].' href="'.$events[date('Ymd', $Time)][0].'" title="'.$eventstitle[date('Ymd', $Time)][0].'">'.date('j', $Time).'</a>';
				} else {
				  echo '<td class="agenda'.(date('m', $Time) != $M ? 'not' : '').'this'.(date('Ymd', $Time) == date('Ymd') ? 'day' : 'month').' events">';
				  echo '<a href="spip.php?page=agenda&amp;id_rubrique=#ID_RUBRIQUE" title="[(#TITRE|attribut_html)]">'.date('j', $Time).'</a>';
				}
		} else  {
			echo '<td class="agenda'.(date('m', $Time) != $M ? 'not' : '').'this'.(date('Ymd', $Time) == date('Ymd') ? 'day' : 'month').'">';
			echo date('j', $Time);
		}
		echo '</td>';
		$TempD++;
	        $Time =  mktime(0, 0, 0, $M, $TempD, $Y);
	}
	?>
</tr>
</table>
<div class="agendaderniersajouts">
	<B_AgendaDerniersAjouts>
	<ul>
	<BOUCLE_AgendaDerniersAjouts(EVENEMENTS){id_article IN #GET{articlesbranche}}{par date_debut}{0,(#CONFIG{soyezcreateurs/nombres_agenda,5})}{date_debut>=(#ENV{date}|affdate{'Y-m-d'})}>
	<li><BOUCLE_DernierEvenementArticle(ARTICLES){id_article}><a href="#URL_ARTICLE##ID_EVENEMENT"[ title="(#_DernierEvenementArticle:TITRE|!={#_AgendaDerniersAjouts:TITRE}|?{[(#TITRE|attribut_html)] - [(#_AgendaDerniersAjouts:DATE_DEBUT|afficher_les_dates{#_AgendaDerniersAjouts:DATE_FIN,#_AgendaDerniersAjouts:HORAIRE,0,0,0,0})],[(#DESCRIPTIF|attribut_html)] - [(#_AgendaDerniersAjouts:DATE_DEBUT|afficher_les_dates{#_AgendaDerniersAjouts:DATE_FIN,#_AgendaDerniersAjouts:HORAIRE,0,0,0,0})]})"]></BOUCLE_DernierEvenementArticle>#TITRE</a></li>
	</BOUCLE_AgendaDerniersAjouts>
	</ul>
	</B_AgendaDerniersAjouts>
	</div>
</div>
<div class="centrer_div">
<a href="[(#URL_PAGE{backendagenda}|parametre_url{id_rubrique,#ID_SECTEUR})]"><img src="/#CHEMIN{images/fairytale_date_rss_24.png}" alt="<:pyrat:syndiquer_agenda:>&nbsp;: [(#TITRE|attribut_html)]" width="52" height="24" /></a>
</div>
</BOUCLE_agenda>
</div><!-- class="miniagenda" -->
</B_agenda>