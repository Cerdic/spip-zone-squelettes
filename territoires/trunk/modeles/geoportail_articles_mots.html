[(#REM)
- titre	     : titre de la couche
- legende    : groupe de mot cle a utiliser comme legende (représentation en fonction du logo du mot cle)
- taille     : taille des icones : 25px
- couleur    : couleur du bord : #FFFFFF 
- bord       : taille du bord : 4
- id_auteur	 : limiter a un auteur
- id_rubrique: limiter a une rubrique
- id_secteur : limiter a un secteur
- id_mot     : limiter a un mot cle
- id_groupe  : limiter a un groupe de mot cle
- recadre    : ajuster l'emprise aux objets
Parametres issus du modele GEOPORTAIL : 
- id_geoportail   : si on veux plusieurs cartes
- lon , lat, zoom, zone, mode, layerctrl, toolbox, infobox, searchtools, measuretools, carto, ortho, width, height
]
<script type="text/javascript">

// Fonction générale réservée aux popups, pour tous les points
function mon_popup (feature, pos, hover)
{      
	   // Gestion du survol
       if (hover)
		{ // Sauver
		var pop = feature.attributes.popup;
		// Supprimer
		feature.attributes.popup = null;
		// Appeler la fonction par défaut
		spipGeoportail.popupFeature(feature, pos, hover);
		// Restaurer
		feature.attributes.popup = pop;
		}
       // Gestion du click
       else
       { document.location = feature.attributes.url;}
}

// Ouverture de la fonction principale de carte

function initSpipMap#ENV{id_geoportail,0} (map,id)
{	
	// Definition générale des styles pour l'affichage sous forme de punaises
	var extent = new OpenLayers.Bounds();
	var symbolizer = OpenLayers.Util.applyDefaults(
			{pointRadius: 10, graphicXOffset: -2, graphicYOffset: -17, cursor:'pointer'},
			OpenLayers.Feature.Vector.style["default"]);
	var styleMap = new OpenLayers.StyleMap({"default": symbolizer, "select": {pointRadius: [(#ENV{taille,10}|mult{1.5})], graphicXOffset: -4, graphicYOffset: -26}});
	
<BOUCLE_articleslibres(ARTICLES) {id_rubrique}{geoposition}{!id_groupe=#ENV{legende,0}}>

	// Rajoute une couche commune pour tous les articles de cette boucle
	var l = new OpenLayers.Layer.Vector("[(#ENV{titre}|sinon{<:spip:icone_articles:>})]",{ styleMap: styleMap, opacity:1, visibility:1, originators: jQuery.geoportail.originators });
	map.rlayer = l;
	map.getMap().addLayer(l);
	// Couche selectable
	map.selectionnable(l);
				
	// Ajouter les articles dans la couche
	var extent = new OpenLayers.Bounds();
	<BOUCLE_geo_articleslibres(ARTICLES){geoposition}{id_auteur?}{id_rubrique?}{id_secteur?}{id_mot?}{!id_groupe=#ENV{legende,0}}{par date}{inverse}{0,#ENV{max,200}}>
	{	var lon = #LON;
		var lat = #LAT;

			[(#SET{largeur,[(#LOGO_ARTICLE||image_reduire{40}|largeur|plus{[(#ENV{bord,10})]})]})]
			[(#SET{hauteur,[(#LOGO_ARTICLE||image_reduire{40}|hauteur|plus{[(#ENV{bord,10})]})]})]
			var feature = jQuery.geoportail.createFeature (map, lon,lat, "[(#LOGO_ARTICLE||image_reduire{40}|image_recadre{#GET{largeur},#GET{hauteur},center,#ENV{couleur,#FFFFFF}}|extraire_attribut{src})]",#ENV{taille,25});

		feature.attributes.logo = "[(#LOGO_ARTICLE||image_reduire{60}|replace{'"',"'"})]";
		feature.attributes.name = "[(#TITRE|supprimer_numero|attribut_html)]";
		feature.attributes.url = "[(#URL_ARTICLE|url_absolue)]";
		feature.attributes.popup = mon_popup ;
		feature.attributes.description = "[(#INTRODUCTION|couper{100}|addslashes|replace{\n,''}|replace{\r,''})]";
		map.rlayer.addFeatures(feature);
		extent.extend(feature.geometry.getBounds());
	}
	</BOUCLE_geo_articleslibres>

</BOUCLE_articleslibres>	

<BOUCLE_articlesmotlegende(ARTICLES){id_rubrique}{geoposition}{id_groupe=#ENV{legende,0}}>
<BOUCLE_gmot(MOTS){id_groupe=#ENV{legende,0}}{id_article}{doublons}>

	// Pour les mots-clés choisis en légende : prendre le logo du mot pour les points
	symbolizer = OpenLayers.Util.applyDefaults(
			{ pointRadius: [(#ENV{taille,10})], externalGraphic:"[(#LOGO_MOT||extraire_attribut{src})]", graphicXOffset: -4, graphicYOffset: -26, cursor:'pointer'},
			OpenLayers.Feature.Vector.style["default"]);
			
	// Definition d'une legende sur le mot-cle : au survol, grossissement du point
	styleMap = new OpenLayers.StyleMap(
		{	"default": symbolizer, 
			"select": { pointRadius: [(#ENV{taille,10}|mult{1.5})], externalGraphic:"[(#LOGO_MOT||extraire_attribut{src})]", graphicXOffset: -4, graphicYOffset: -26 }
		});

	// Rajoute une couche par mot-clé pour les points
	var l = new OpenLayers.Layer.Vector("[(#TITRE|attribut_html)]",{ styleMap: styleMap, opacity:1, visibility:1, originators: jQuery.geoportail.originators });
	map.rlayer = l;
	map.getMap().addLayer(l);
	// Couche selectable
	map.selectionnable(l);
				
	// Ajouter les articles dans chaque couche
	<BOUCLE_geo_articlesmotlegende(ARTICLES){geoposition}{id_auteur?}{id_rubrique?}{id_secteur?}{id_mot}{id_groupe?}{par date}{inverse}{0,#ENV{max,200}}>
	{	var lon = #LON;
		var lat = #LAT;
		<BOUCLE_mot(MOTS){id_groupe=#ENV{legende,0}}{id_article}{0,1}>
			var feature = jQuery.geoportail.createFeature (map,lon,lat);
			feature.attributes.mot_cle = "[(#TITRE**|attribut_html)]";
		</BOUCLE_mot>
			[(#SET{largeur,[(#LOGO_ARTICLE||image_reduire{40}|largeur|plus{[(#ENV{bord,4})]})]})]
			[(#SET{hauteur,[(#LOGO_ARTICLE||image_reduire{40}|hauteur|plus{[(#ENV{bord,4})]})]})]
			var feature = jQuery.geoportail.createFeature (map, lon,lat, "[(#LOGO_ARTICLE||image_reduire{40}|image_recadre{#GET{largeur},#GET{hauteur},center,#ENV{couleur,#FFFFFF}}|extraire_attribut{src})]",#ENV{taille,25});
		<//B_mot>
		feature.attributes.logo = "[(#LOGO_ARTICLE||image_reduire{60}|replace{'"',"'"})]";
		feature.attributes.name = "[(#TITRE|supprimer_numero|attribut_html)]";
		feature.attributes.url = "[(#URL_ARTICLE|url_absolue)]";
		feature.attributes.description = "[(#CHAPO|couper{100}|addslashes|replace{\n,''}|replace{\r,''})]";
		feature.attributes.popup = mon_popup ;
		map.rlayer.addFeatures(feature);
		extent.extend(feature.geometry.getBounds());
	}
	</BOUCLE_geo_articlesmotlegende>
</BOUCLE_gmot>
</BOUCLE_articlesmotlegende>




	[(#RECADRE|?{" "})
	// Tout afficher
	map.getMap().zoomToExtent(extent);
	if (map.getMap().getZoom() > 16) map.getMap().zoomTo(17);
	]
}

</script>
[(#MODELE{geoportail}{id_geoportail=#ENV{id_geoportail,0}}{overview=1}{searchtools}{measuretools}{zone}{mode}{lon}{lat}{zoom}{min_zoom}{layerctrl}{toolbox}{infobox}{carto}{ortho}{width}{height})]
