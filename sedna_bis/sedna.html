<?php
	// l'identifiant du lien est fonction de son url et de sa date
	// ce qui permet de reperer les "updated" *et* les doublons
	//include_spip('inc/filtres');
	function afficher_lien(
		$id_syndic_article,
		$id_lien,
		$id_syndic,
		$date,
		$url,
		$titre,
		$lesauteurs,
		$desc,
		$lang
		) {
		static $vu, $lus, $ferme_ul, $id, $iddesc;
		global $ex_syndic, $class_desc;

		// Articles a ignorer
		if (!$_GET['id_syndic']
		AND $_COOKIE['sedna_ignore_'.$id_syndic])
			return;

		// initialiser la liste des articles lus
		if (!is_array($lus))
			$lus = array_flip(split('-', '-'.$_COOKIE['sedna_lu']));

		if ($vu[$id_lien]++) return;

		// regler la classe des liens, en fonction du cookie sedna_lu
		$class_link = $lus[$id_lien] ? 'vu' : '';

		if (unique(substr($date,0,10)))
			$affdate = '<h1 class="date">'
				.jour($date).' '.nom_mois($date).'</h1>';


		// indiquer un intertitre si on change de source ou de date
		if ($affdate OR ($id_syndic != $ex_syndic)) {
			echo $ferme_ul; $ferme_ul="</ul>\n";
			echo $affdate;
		}

		// Suite intertitres
		if ($affdate OR ($id_syndic != $ex_syndic)) {
			echo "<h2 id='site${id_syndic}_".(++$id)."'
			onmouseover=\"getElementById('url".$id."').className='urlsiteon';\"
			onmouseout=\"getElementById('url".$id."').className='urlsite';\"
			>";
			echo "<a href=\"?id_syndic=$id_syndic";
			if ($age = intval($GLOBALS['age']))
				echo "&amp;age=$age";
			echo "\">".$GLOBALS['nom_site_'.$id_syndic]
				."</a>";
			echo " <a class=\"urlsite\"
					href=\""
					.$GLOBALS['url_site_'.$id_syndic]
					.'" id="url'.$id.'">'
					.$GLOBALS['url_site_'.$id_syndic]
					."</a>";
			echo "</h2>\n<ul>\n";
			$ex_syndic = $id_syndic;
		}

		echo "<li class='entry'";
		if (!$_GET['id_syndic'] AND !strlen($_GET['recherche']))
			echo " id='item${id_syndic}_${id_syndic_article}'";
		echo "	onmousedown=\"jai_lu('$id_lien');\">\n",
#		"<small>".affdate($date,'H:i')."</small>",
		"<abbr class='published updated'
		title='".date_iso($date)."'>".affdate($date,'H:i')."</abbr>", 
		"<div class=\"titre\">",
		"<a href=\"$url\"
			title=\"$url\"
			class=\"link$class_link\"
			id=\"news$id_lien\"
			rel=\"bookmark\"";
		if ($lang) echo " hreflang=\"$lang\"";
		echo ">",
		"<span class=\"title\">", # le "title" du microformat hAtom.feed.entry
		$titre, "</span></a>",
		$lesauteurs,
		"\n<span class=\"source\"><a href=\"",
		$GLOBALS['url_site_'.$id_syndic]."\">",
		$GLOBALS['nom_site_'.$id_syndic]."</a></span>\n",
		"</div>\n";

		if ($desc)
			echo "<div class=\"desc\">",
			"<div class=\"$class_desc\" id=\"desc_".(++$iddesc)."\">\n",
			"<span class=\"content\">", $desc, "</span>\n",
			'</div></div>';
		

		echo "\n</li>\n";
		}
?><INCLURE{fond=sedna_header}{id_syndic}{recherche}{age}{var_color}>

[(#REM)
	Microformat hAtom !
]
<div class="feed">
<div class="top">
<div class="title">
<a href="#URL_PAGE{sedna}">Sedna RSS</a>
	&nbsp;
<BOUCLE_titre(SITES){id_syndic}>#NOM_SITE
	&nbsp;
	<small><a href="[(#URL_SITE|abs_url)]">#URL_SITE</a></small>
</BOUCLE_titre>
	#NOM_SITE_SPIP
	&nbsp;
	<small><a href="#URL_SITE_SPIP/">#URL_SITE_SPIP/</a></small>
<//B_titre>

</div>

<div class="topdate">
	[(#ENV{recherche}|=={''}|?{&nbsp;,''})
	<?php
		include_spip('inc/filtres');
		// date de maintenant, pas du cache
		$date = date('Y-m-d');
		echo nom_jour($date),' ',affdate_court($date), ' ',date('H:i');
	?>
	][<b><:info_rechercher_02:> &laquo; (#ENV{recherche}) &raquo;</b>]
</div>

</div>

<div class="marge">
<h1><:sedna_articles_recents_court:></h1>
<ul>
	<li><a href="[(#SELF|parametre_url{age,''})]"
	class="[(#ENV{age}|=={''}|?{'selected',''})]"><:date_aujourdhui|ucfirst:></a></li>
	<li><a href="[(#SELF|parametre_url{age,2})]"
	class="[(#ENV{age}|=={2}|?{'selected',''})]"><:sedna_deuxjours:></a></li>
	<li><a href="[(#SELF|parametre_url{age,7})]"
	class="[(#ENV{age}|=={7}|?{'selected',''})]"><:sedna_semaine:></a></li>
	<li><a href="[(#SELF|parametre_url{age,31})]"
	class="[(#ENV{age}|=={31}|?{'selected',''})]"><:sedna_mois:></a></li>
	<li><a href="[(#SELF|parametre_url{age,365})]"
	class="[(#ENV{age}|=={365}|?{'selected',''})]"><:sedna_annee:></a></li>
</ul>
<h1>&nbsp;</h1>
<form action="#SELF" method="get">
<div>
	<input type="text" name="recherche" value="[(#ENV{recherche})]" size="10" />
	[<input type="hidden" name="age" value="(#ENV{age})" />]
	[<input type="hidden" name="id_syndic" value="(#ENV{id_syndic})" />]
	<input type="submit" name="" value="<:info_rechercher|attribut_html:>" style="font-size:9px;" />
</div>
</form>

<h1><:sedna_preferences:></h1>

<ul>
<li><a class="<?php echo $sel2; ?>" id="desc_afficher" onmousedown="style_desc('afficher'); return false;"><:sedna_aff_resume:></a></li>
<li><a class="<?php echo $sel1; ?>" id="desc_masquer" onmousedown="style_desc('masquer'); return false;"><:sedna_masquer_resume:></a></li>
</ul>

<?php
	// Si on se connecte on peut memoriser son cookie
	if ($auteur_session) { ?>

<ul>
<li>
<a id="synchrooui"
	<?php if ($_COOKIE['sedna_synchro'] == 'oui') echo " class='selected'"; ?>
	onclick="sedna_synchro('oui');document.location=document.location;"
	title="<:sedna_synchro_titre:>"
><:sedna_synchro:><?php echo $synchro; ?></a>
</li>
<li>
<a id="synchronon"
	<?php if ($_COOKIE['sedna_synchro'] != 'oui') echo " class='selected'"; ?>
	onclick="sedna_synchro('non');"
><:sedna_pas_synchro:></a>
</li>
</ul>


<ul>

<?php
	if ($auteur_session['statut'] == '0minirezo') {
?>

<li>
<a href="ecrire/?exec=[(#ENV{id_syndic}|?{sites,sites_tous})][&amp;id_syndic=(#ENV{id_syndic})]">[(#ENV{id_syndic}|?{<:ecrire:icone_modifier_site:>, <:login_acces_prive:>})]</a>
</li>

<?php } ?>

	<li><a href="#URL_LOGOUT"><:sedna_deconnexion:></a></li>
</ul>

<?php } else { ?>

<ul>
<li>
<a href="[(#URL_PAGE{login}|parametre_url{url,#URL_PAGE{sedna}})]"><:sedna_connexion:></a>
</li>
</ul>

<?php } ?>

[(#REM) Selecteur de couleur ]
<ul>
<li>
<?php
	foreach ($couleurs as $nom => $valeurs) {
		echo "<a class='normal' href='./?var_color=$nom'
		style='display:inline; background-color: ".$valeurs[1].";'
		>&nbsp;&nbsp;</a> ";
	}
?>
</li>
</ul>



<h1><:sedna_sources:></h1>
<ul>
	<li><a href="#URL_PAGE{sedna}" class="[(#ENV{id_syndic}|=={''}|?{'selected',''})]"><b><:sedna_toutes:></b></a></li>
</ul>

<ul>
<BOUCLE_sites(SITES){par nom_site}{syndication!=non}>
<li>
<a href="[(#URL_PAGE{sedna}|parametre_url{id_syndic,#ID_SYNDIC})][&amp;age=(#ENV{age})]"
		class="[(#ENV{id_syndic}|=={#ID_SYNDIC}|?{'selected',''})]"
	><?php
		if ($_COOKIE['sedna_ignore_[(#ID_SYNDIC)]']) {
			echo '<span
			onclick="change_site( #ID_SYNDIC ); document.location=document.location; return false;"
			style="float: #LANG_RIGHT;"
			title="<:sedna_afficher_sources:>">+</span> ';
			echo '<s>';
		} else {
			echo '<span
			onclick="change_site( #ID_SYNDIC ); document.location=document.location; return false;"
			style="float: #LANG_RIGHT;"
			title="<:sedna_masquer_sources:>">-</span> ';
		}
	?>[(#SYNDICATION|syndication_en_erreur|?{<span title="<:sedna_probleme_de_syndication:>"> &#x2193;</span>,''}) ]#NOM_SITE<?php
		if ($_COOKIE['sedna_ignore_[(#ID_SYNDIC)]']) {
			echo '</s>';
		}
	?></a>
</li>
<?php
	$nom_site_#ID_SYNDIC = '[(#NOM_SITE|texte_script)]';
	$url_site_#ID_SYNDIC = '[(#URL_SITE|abs_url|texte_script)]';
?>
</BOUCLE_sites>
</ul>


<h1>Sedna</h1>
<ul>
<li><a href="http://sedna.spip.org/">Sedna RSS</a></li>
<li><a href="http://www.spip.net/">SPIP</a></li>
<li><a href="http://zone.spip.org/trac/spip-zone/">SPIP-Zone</a></li>
<li><a href="http://www.gnu.org/copyleft/gpl.html">copyleft - GNU/GPL</a></li>
<li><a href="http://validator.w3.org/check?uri=[(#URL_SITE_SPIP|urlencode)]%2Fsedna%2F[(#SELF|urlencode)]">XHTML 1.0 Strict</a></li>
<li><a href="http://microformats.org/wiki/hatom">hAtom</a></li>
</ul>

#MENU_LANG

</div>


[(#REM)
	Pour la boucle principale, on se base
	sur le microformat hAtom (voir le projet hBones)
	<http://microformats.org/wiki/hatom>
]
<div class="milieu">

<B_syndic>


<div id="total_articles">
#TOTAL_BOUCLE [(#TOTAL_BOUCLE|=={1}|?{<:sedna_liens:>,<:sedna_liens_pluriel:>})]
</div>

[(#REM)
	Voir la definition des criteres {contenu} et {tri_sedna} dans sedna.php
]
<?php
<BOUCLE_syndic(SYNDIC_ARTICLES) {id_syndic?} {contenu} {tri_sedna} {age<=#ENV{age,1}} {0,500}>
	afficher_lien(
	#ID_SYNDIC_ARTICLE,
	'[(#URL_ARTICLE|creer_identifiant{#DATE})]',
	#ID_SYNDIC,
	'#DATE',
	'[(#URL_ARTICLE|attribut_html|texte_script)]',
	'[(#TITRE**|supprimer_numero|sinon{<:ecrire:info_sans_titre:>}|nettoyer_texte)]',
	'[ - <span class="author">(#LESAUTEURS**|nettoyer_texte)</span>]',
	'[(#DESCRIPTIF**|nettoyer_texte)][ -- (#TAGS|texte_script)][ ((#SOURCE**|nettoyer_texte))]',
	'#LANG'
	);
</BOUCLE_syndic>
?>
</ul>
</B_syndic>

	<div id="total_articles"><:sedna_pas_articles:></div>
	<div class="centre_image">
		<img src="#DOSSIER_SQUELETTE/sedna-big.png" alt="" width="196" height="196" />
	</div>

<//B_syndic>

</div>

<div class="bottom">
<div class="bottomrss">
<BOUCLE_url_backend_ori2(SITES){id_syndic}>
	 <a
href="#URL_SITE_SPIP/[(#URL_PAGE{sedna}|parametre_url{rss,1})]&amp;id_syndic=#ID_SYNDIC[&amp;recherche=(#ENV{recherche})]"
title="RSS [(#NOM_SITE|attribut_html)], via [(#NOM_SITE_SPIP|attribut_html)]"
	><span class="rss-button">RSS</span></a>
[	 <a
href="(#URL_SYNDIC)"
title="RSS original [(#NOM_SITE|attribut_html)]"
	><span class="rss-button">RSS</span></a>
]
</BOUCLE_url_backend_ori2>
	 <a
		 href="#URL_SITE_SPIP/[(#URL_PAGE{sedna}|parametre_url{rss,1})][&amp;recherche=(#ENV{recherche})]"
title="RSS [(#NOM_SITE_SPIP|attribut_html)][ ((#ENV{recherche}|attribut_html))]"
	><span class="rss-button">RSS</span></a>
<//B_url_backend_ori2>
</div>

<BOUCLE_refresh(SITES){id_syndic=#ENV{id_syndic}}>
	<?php
		if ($auteur_session['statut'] == '0minirezo') { 
			$ignore = true;
	?>
	[(#ENV{refresh}|=={#ENV{id_syndic}}|?{' ',''}) <:sedna_syndication_fait:>]
	[(#ENV{refresh}|=={#ENV{id_syndic}}|?{'',<!-- #SYNDICATION -->})
		[<:sedna_derniere_syndication:>
		(#DATE_SYNDIC|date_relative) - ]
	<a href="[(#SELF|parametre_url{refresh,#ID_SYNDIC})]"><:sedna_syndication_ajour:></a>]
	[- (#SYNDICATION|syndication_en_erreur)]

<?php } ?>
</BOUCLE_refresh>

<?php
	if (!$ignore)
		echo "<:sedna_derniere_syndication:>"
		.date_relative('[(#ENV{max_maj})]');
?>

</div>
</div>[(#REM) /feed]

#SPIP_CRON

<INCLURE{fond=sedna_footer}>
