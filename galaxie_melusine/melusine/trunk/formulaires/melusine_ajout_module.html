#FILTRE{ŧrim}
[(#REM)




	On récupère la liste des modules dispos, triés par unicité

]
[(#SET{modules_dispo,[(#BLOC|melusine_liste_modules_autorises{#TYPE}|sinon{#ARRAY})]})]
[(#SET{modules_dispo_tries,[(#GET{modules_dispo}|melusine_trier_uniques)]}
)]


[(#REM)




	On récupère la liste des modules déjà pris et qui sont
	supposés être uniques

]
<BOUCLE_modules_pris(NOISETTES){type}>
[(#GET{modules_dispo_tries}|table_valeur_cleslash{uniques!#NOISETTE!unique}|=={oui}|oui)
	[(#SET{modules_pris_uniques,[(#GET{modules_pris_uniques}|sinon{#ARRAY}|push{#NOISETTE})]}
	)]
]
</BOUCLE_modules_pris>
[(#REM)



	Dans la pile des modules dipos, on
	enlève ceux qui sont pris et uniques
]
[(#SET{modules_utilisables,[(#GET{modules_dispo}|sinon{#ARRAY}|array_diff_key{#GET{modules_pris_uniques}|sinon{#ARRAY}|array_flip})]})]
[(#REM)



	Et on affiche le formulaire avec la liste
	des modules que l'on peu ajouter
]
<div class="formulaire_spip formulaire_deplacer_module">
	[<p class="reponse_formulaire reponse_formulaire_erreur">(#ENV*{message_erreur})</p>]
	[<p class="reponse_formulaire reponse_formulaire_ok">(#ENV*{message_ok})</p>]
	<form action="#ENV{action}" method="post"><div>
		#ACTION_FORMULAIRE{#ENV{action}}
		<ul class="boutons ajouter_module obligatoire">
<BOUCLE_dispos(POUR){tableau #GET{modules_utilisables}}{si #ENV{editable}|oui}>
			<li id="[(#CLE|attribut_html)]" class="deplier">
				<div class="haut_module voisin_pliant">
					<button type='submit' title="Ajouter ce module"  name='nom_module' value="[(#CLE|attribut_html)]">Ajouter</button>
					[(#CHEMIN{[(#VALEUR|table_valeur_cleslash{icon})]}
							|balise_img{icône,icone_module}
							|image_reduire{30,30}
					)]
					<span class="nom_module">[(#VALEUR|table_valeur_cleslash{nom}|spip_ucfirst)]</span>
				</div>[
				<div class="description_module pliant">
					(#VALEUR|table_valeur_cleslash{description}|propre)
				</div>]
			</li>
</BOUCLE_dispos>
		</ul>
	</div></form>
</div>